# ğŸ”„ AgarFi Protocol Flow Diagrams

## x403 Authentication Request Cycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚                                      â”‚   Server    â”‚
â”‚   (Client)  â”‚                                      â”‚  (AgarFi)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                     â”‚
       â”‚  1. POST /api/auth/challenge                       â”‚
       â”‚     { walletAddress: "56FD..." }                   â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                     â”‚
       â”‚                                                     â”‚ 2. Generate challenge
       â”‚                                                     â”‚    - Create random nonce
       â”‚                                                     â”‚    - Set 3-min expiry
       â”‚                                                     â”‚
       â”‚  3. HTTP 403 Forbidden                             â”‚
       â”‚     { challenge: {                                 â”‚
       â”‚         message: "Sign this...",                   â”‚
       â”‚         nonce: "abc123...",                        â”‚
       â”‚         expiresAt: timestamp                       â”‚
       â”‚     }}                                              â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                                     â”‚
       â”‚                                                     â”‚
   â”Œâ”€â”€â”´â”€â”€â”                                                  â”‚
   â”‚     â”‚ 4. User signs message in Phantom                 â”‚
   â”‚  ğŸ‘¤ â”‚    - NOT a transaction                           â”‚
   â”‚     â”‚    - Costs $0                                    â”‚
   â”‚     â”‚    - Creates signature with private key          â”‚
   â””â”€â”€â”¬â”€â”€â”˜                                                  â”‚
       â”‚                                                     â”‚
       â”‚  5. POST /api/auth/verify                          â”‚
       â”‚     Authorization: Bearer <signed_challenge>       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                     â”‚
       â”‚                                                     â”‚ 6. Verify signature
       â”‚                                                     â”‚    - Check nonce valid
       â”‚                                                     â”‚    - Verify ed25519 sig
       â”‚                                                     â”‚    - Check not expired
       â”‚                                                     â”‚
       â”‚                                                     â”‚ 7. Create session
       â”‚                                                     â”‚    - Generate JWT token
       â”‚                                                     â”‚    - Store in MongoDB
       â”‚                                                     â”‚    - 30-min expiry
       â”‚                                                     â”‚
       â”‚  8. HTTP 200 OK                                    â”‚
       â”‚     { authenticated: true,                         â”‚
       â”‚       sessionToken: "eyJhb...",                    â”‚
       â”‚       expiresAt: timestamp }                       â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                                     â”‚
       â”‚                                                     â”‚
   [Store token in localStorage]                           â”‚
   [Valid for 30 minutes]                                   â”‚
       â”‚                                                     â”‚
```

---

## x402 Payment Request Cycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚                                      â”‚   Server    â”‚
â”‚   (Client)  â”‚                                      â”‚  (AgarFi)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                     â”‚
       â”‚  1. POST /api/join-lobby                           â”‚
       â”‚     X-SESSION: <session_token>                     â”‚
       â”‚     { tier: "1", playerId, playerName }            â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                     â”‚
       â”‚                                                     â”‚ 2. Validate session
       â”‚                                                     â”‚    - Verify JWT token
       â”‚                                                     â”‚    - Check MongoDB
       â”‚                                                     â”‚
       â”‚                                                     â”‚ 3. Check if payment needed
       â”‚                                                     â”‚    - tier != 'dream'
       â”‚                                                     â”‚    - requiresPayment: true
       â”‚                                                     â”‚
       â”‚  4. HTTP 402 Payment Required                      â”‚
       â”‚     { x402Version: 1,                              â”‚
       â”‚       accepts: [{                                  â”‚
       â”‚         network: "solana-mainnet",                 â”‚
       â”‚         asset: "USDC_MINT",                        â”‚
       â”‚         payTo: "FcAE...zPoP",                      â”‚
       â”‚         maxAmountRequired: "1000000"               â”‚
       â”‚     }]}                                             â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                                     â”‚
       â”‚                                                     â”‚
   â”Œâ”€â”€â”´â”€â”€â”                                                  â”‚
   â”‚     â”‚ 5. User signs transaction in Phantom            â”‚
   â”‚  ğŸ‘¤ â”‚    - Pay 1 USDC to platform wallet              â”‚
   â”‚     â”‚    - Transaction broadcast to Solana            â”‚
   â””â”€â”€â”¬â”€â”€â”˜                                                  â”‚
       â”‚                                                     â”‚
       â”‚                                                     â”‚
       â”‚  6. GET transaction signature                      â”‚
       â”‚     txSig = "3GW9r5Zi..."                          â”‚
       â”‚                                                     â”‚
       â”‚                                                     â”‚
       â”‚  7. POST /api/join-lobby (retry)                   â”‚
       â”‚     X-SESSION: <session_token>                     â”‚
       â”‚     X-PAYMENT: <payment_proof>                     â”‚
       â”‚     { tier: "1", ... }                             â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                     â”‚
       â”‚                                                     â”‚ 8. Decode X-PAYMENT
       â”‚                                                     â”‚    - Extract signature
       â”‚                                                     â”‚    - Get from/to/amount
       â”‚                                                     â”‚
       â”‚                                                     â”‚ 9. Verify on blockchain
       â”‚                                                â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                                                â”‚ Solana  â”‚
       â”‚                                                â”‚   RPC   â”‚
       â”‚                                                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                                                     â”‚ 10. Check transaction
       â”‚                                                     â”‚     - Sender matches
       â”‚                                                     â”‚     - Recipient matches
       â”‚                                                     â”‚     - Amount â‰¥ required
       â”‚                                                     â”‚     - TX succeeded
       â”‚                                                     â”‚
       â”‚                                                     â”‚ 11. Record payment
       â”‚                                                â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
       â”‚                                                â”‚ MongoDB â”‚
       â”‚                                                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚                                                     â”‚
       â”‚                                                     â”‚ 12. Create lobby token
       â”‚                                                     â”‚     - Generate JWT
       â”‚                                                     â”‚     - Include playerId
       â”‚                                                     â”‚
       â”‚  13. HTTP 200 OK                                   â”‚
       â”‚      { success: true,                              â”‚
       â”‚        verified: true,                             â”‚
       â”‚        lobbyToken: "eyJhb..." }                    â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                                     â”‚
       â”‚                                                     â”‚
   [Navigate to /game]                                      â”‚
   [Connect Socket.io with lobbyToken]                      â”‚
       â”‚                                                     â”‚
```

---

## Combined Flow: x403 + x402 (Full Game Join)

```
USER ACTION: Click "Join $1 Game"
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: x403 Authentication (First Time Only)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client                          Server                    Phantom
  â”‚                                â”‚                          â”‚
  â”‚ Check localStorage for token   â”‚                          â”‚
  â”‚ â†’ Not found or expired         â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”œâ”€ POST /api/auth/challenge â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚<â”€â”€â”€ HTTP 403 + Challenge â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                                â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€ Open modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚                                â”‚      â”Œâ”€ User clicks "Sign"
  â”‚                                â”‚      â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sign Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                â”‚                        (Shows text,
  â”‚                                â”‚                         NOT transaction)
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Signature â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                â”‚                          â”‚
  â”œâ”€ POST /api/auth/verify â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚   (with signature)             â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚                                â”œâ”€ Verify ed25519          â”‚
  â”‚                                â”œâ”€ Create MongoDB session  â”‚
  â”‚                                â”‚                          â”‚
  â”‚<â”€â”€â”€ HTTP 200 + sessionToken â”€â”€â”€â”¤                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚ Store in localStorage          â”‚                          â”‚
  â”‚ (valid 30 minutes)             â”‚                          â”‚
  â”‚                                â”‚                          â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: x402 Payment (Every Game)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”‚                                â”‚                          â”‚
  â”œâ”€ POST /api/join-lobby â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚   X-SESSION: <token>           â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚                                â”œâ”€ Validate session        â”‚
  â”‚                                â”‚                          â”‚
  â”‚<â”€â”€â”€ HTTP 402 Payment Required â”€â”¤                          â”‚
  â”‚     (USDC amount + wallet)     â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚                                â”‚      â”Œâ”€ User approves payment
  â”‚                                â”‚      â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sign Transaction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                                â”‚                        (Shows amount,
  â”‚                                â”‚                         destination,
  â”‚                                â”‚                         network fee)
  â”‚                                â”‚                          â”‚
  â”‚                           Broadcast to Solana             â”‚
  â”‚                                â–¼                          â”‚
  â”‚                          [ Blockchain ]                   â”‚
  â”‚                          1 USDC transferred               â”‚
  â”‚                                â”‚                          â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TX Signature â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”œâ”€ POST /api/join-lobby (retry) â”¤                          â”‚
  â”‚   X-SESSION: <token>           â”‚                          â”‚
  â”‚   X-PAYMENT: <proof>           â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚                                â”œâ”€ Query Solana RPC        â”‚
  â”‚                                â”œâ”€ Verify TX on-chain âœ“    â”‚
  â”‚                                â”œâ”€ Check sender âœ“          â”‚
  â”‚                                â”œâ”€ Check amount âœ“          â”‚
  â”‚                                â”œâ”€ Save to MongoDB         â”‚
  â”‚                                â”œâ”€ Create lobby token      â”‚
  â”‚                                â”‚                          â”‚
  â”‚<â”€â”€â”€ HTTP 200 + lobbyToken â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                                â”‚                          â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: Socket.io Game Join (Verified)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”‚                                â”‚                          â”‚
  â”œâ”€ Navigate to /game            â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”œâ”€ Connect Socket.io â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”œâ”€ playerJoinLobby â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚   { lobbyToken }               â”‚                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚                                â”œâ”€ Verify JWT              â”‚
  â”‚                                â”œâ”€ Check MongoDB session   â”‚
  â”‚                                â”œâ”€ Add to lobby            â”‚
  â”‚                                â”œâ”€ Fill with bots          â”‚
  â”‚                                â”‚                          â”‚
  â”‚<â”€â”€â”€ lobbyJoined â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚                          [120s countdown]                â”‚
  â”‚                                â”‚                          â”‚
  â”‚<â”€â”€â”€ gameStart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                                â”‚                          â”‚
  â”‚<â•â•â• gameState (60Hz) â•â•â•â•â•â•â•â•â•>â”‚                          â”‚
  â”‚                                â”‚                          â”‚
           [GAME IN PROGRESS]
```

---

## Simplified Combined View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FULL GAME JOIN FLOW                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 1. x403: Request challenge
    â”œâ”€> Server sends 403 + challenge message
    â””â”€> Store challenge (3 min expiry)

 2. x403: User signs message ($0 cost)
    â”œâ”€> Phantom shows text (NOT transaction)
    â””â”€> Returns ed25519 signature

 3. x403: Verify signature
    â”œâ”€> Server validates signature
    â”œâ”€> Creates 30-min session in MongoDB
    â””â”€> Returns session token (JWT)

    [Session valid for 30 minutes - reusable]

 4. x402: Request lobby join
    â”œâ”€> Client sends X-SESSION header
    â””â”€> Server responds 402 + payment details

 5. x402: User pays USDC
    â”œâ”€> Phantom shows transaction ($1 USDC + fee)
    â”œâ”€> User approves
    â””â”€> Broadcasts to Solana blockchain

 6. x402: Verify payment on-chain
    â”œâ”€> Server queries Solana RPC
    â”œâ”€> Checks sender/receiver/amount
    â”œâ”€> Confirms transaction succeeded
    â””â”€> Records payment in MongoDB

 7. x402: Issue lobby token
    â”œâ”€> Server creates lobby JWT
    â””â”€> Returns 200 OK + lobbyToken

 8. Socket.io: Join game
    â”œâ”€> Client connects WebSocket
    â”œâ”€> Sends lobbyToken
    â”œâ”€> Server verifies token
    â””â”€> Player added to lobby

 9. Game starts (120s countdown)
    â””â”€> Real-time multiplayer begins (60Hz)

```

---

## Error Handling Flows

### x403 Authentication Failure

```
Client                     Server
  â”‚                          â”‚
  â”œâ”€ POST /auth/verify â”€â”€â”€â”€â”€>â”‚
  â”‚   (bad signature)        â”‚
  â”‚                          â”‚
  â”‚                          â”œâ”€ Verify fails âœ—
  â”‚                          â”œâ”€ Record failure
  â”‚                          â”‚   (attempt #1-5: no lock)
  â”‚                          â”‚   (attempt #6+: progressive timeout)
  â”‚                          â”‚
  â”‚<â”€â”€â”€ HTTP 403 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚     { error: "..." }     â”‚
  â”‚                          â”‚
  â”‚                          â”‚
[Show error in modal]        â”‚
[User can retry]             â”‚
  â”‚                          â”‚
```

### x402 Payment Failure

```
Client                     Server                 Solana
  â”‚                          â”‚                       â”‚
  â”œâ”€ POST /join-lobby â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
  â”‚   X-PAYMENT: <proof>     â”‚                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚                          â”œâ”€ Query TX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚                       â”‚
  â”‚                          â”‚<â”€ TX not found â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                          â”‚   or failed           â”‚
  â”‚                          â”‚                       â”‚
  â”‚<â”€â”€â”€ HTTP 402 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚     { error: "..." }     â”‚                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚                          â”‚                       â”‚
[Show error toast]           â”‚                       â”‚
[User can retry payment]     â”‚                       â”‚
  â”‚                          â”‚                       â”‚
```

---

## Session Reuse (Subsequent Games)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User plays 2nd game within 30 minutes (x403 session reuse)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client                     Server
  â”‚                          â”‚
  â”‚ Check localStorage       â”‚
  â”‚ â†’ sessionToken exists    â”‚
  â”‚ â†’ Not expired âœ“          â”‚
  â”‚                          â”‚
  â”‚                          â”‚
  â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â”‚ â•‘  SKIP x403 - Reuse session token   â•‘
  â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â”‚                          â”‚
  â”‚                          â”‚
  â”œâ”€ POST /join-lobby â”€â”€â”€â”€â”€â”€>â”‚
  â”‚   X-SESSION: <token>     â”‚ (Same token from before)
  â”‚                          â”‚
  â”‚                          â”œâ”€ Validate session âœ“
  â”‚                          â”‚
  â”‚<â”€â”€â”€ HTTP 402 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚     (payment required)   â”‚
  â”‚                          â”‚
  â”‚                          â”‚
[User pays again]            â”‚
[Same x402 flow as before]   â”‚
  â”‚                          â”‚
```

---

## Data Flow Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REQUEST HEADERS USED                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  x403 Challenge Request:                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ POST /api/auth/challenge                                    â”‚ â”‚
â”‚  â”‚ Content-Type: application/json                              â”‚ â”‚
â”‚  â”‚ Body: { walletAddress }                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  x403 Signature Verification:                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ POST /api/auth/verify                                       â”‚ â”‚
â”‚  â”‚ Content-Type: application/json                              â”‚ â”‚
â”‚  â”‚ Authorization: Bearer <base64(signedChallenge)>             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  x402 Initial Request (trigger payment):                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ POST /api/join-lobby                                        â”‚ â”‚
â”‚  â”‚ Content-Type: application/json                              â”‚ â”‚
â”‚  â”‚ X-SESSION: <jwt_session_token>                              â”‚ â”‚
â”‚  â”‚ Body: { tier, playerId, playerName, walletAddress }        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  x402 Payment Proof (after paying):                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ POST /api/join-lobby                                        â”‚ â”‚
â”‚  â”‚ Content-Type: application/json                              â”‚ â”‚
â”‚  â”‚ X-SESSION: <jwt_session_token>                              â”‚ â”‚
â”‚  â”‚ X-PAYMENT: <base64(paymentProof)>                           â”‚ â”‚
â”‚  â”‚ Body: { tier, playerId, playerName, walletAddress }        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Response Status Codes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Code   â”‚  Meaning                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                     â”‚
â”‚  200    â”‚  âœ… Success                                         â”‚
â”‚         â”‚  - Authentication succeeded (x403)                  â”‚
â”‚         â”‚  - Payment verified (x402)                          â”‚
â”‚         â”‚  - Lobby token issued                               â”‚
â”‚         â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                     â”‚
â”‚  402    â”‚  ğŸ’³ Payment Required (x402)                         â”‚
â”‚         â”‚  - Client must pay USDC                             â”‚
â”‚         â”‚  - Response includes payment details                â”‚
â”‚         â”‚  - Client pays, then retries with X-PAYMENT header  â”‚
â”‚         â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                     â”‚
â”‚  403    â”‚  ğŸ” Authentication Required (x403)                  â”‚
â”‚         â”‚  - Client must sign challenge                       â”‚
â”‚         â”‚  - Response includes challenge message              â”‚
â”‚         â”‚  - OR: Invalid signature / expired session          â”‚
â”‚         â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                                     â”‚
â”‚  429    â”‚  â±ï¸  Rate Limited                                   â”‚
â”‚         â”‚  - Too many auth failures                           â”‚
â”‚         â”‚  - Progressive timeout (60s â†’ 24h)                  â”‚
â”‚         â”‚  - Cleared on server restart                        â”‚
â”‚         â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PROTECTION STACK (Bottom to Top)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 7. Game Logic (Server-Authoritative Physics)         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 6. Lobby Token (JWT, verified in Socket.io)          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 5. x402 Payment (Blockchain-verified USDC)           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 4. x403 Session (30-min, MongoDB persistent)         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 3. x403 Signature (Ed25519 cryptographic proof)      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 2. Token Gating (Must hold 100k $AgarFi)             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 1. IP Tracking (One connection per IP)               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Each layer must pass for access to be granted âœ…
```

---

## Key Differences: x403 vs x402

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Aspect        â”‚       x403          â”‚       x402          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Purpose         â”‚ Prove identity      â”‚ Prove payment       â”‚
â”‚ HTTP Status     â”‚ 403 Forbidden       â”‚ 402 Payment Req     â”‚
â”‚ User Action     â”‚ Sign message        â”‚ Send transaction    â”‚
â”‚ Cost            â”‚ $0 (just signature) â”‚ $1+ USDC + gas      â”‚
â”‚ Verification    â”‚ Ed25519 signature   â”‚ Solana blockchain   â”‚
â”‚ Result          â”‚ Session token (JWT) â”‚ Lobby token (JWT)   â”‚
â”‚ Duration        â”‚ 30 minutes          â”‚ Single use          â”‚
â”‚ Frequency       â”‚ Once per session    â”‚ Every game          â”‚
â”‚ Header          â”‚ Authorization       â”‚ X-PAYMENT           â”‚
â”‚ Prevents        â”‚ Bots, multi-account â”‚ Fake payments       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**These diagrams show the complete technical flow of AgarFi's dual-protocol security system.** ğŸ”


